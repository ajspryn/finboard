<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Test Final Implementation</title>
        <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
    </head>
    <body>
        <div class="container mt-4">
            <h1>Test Final: Trend Produk Funding dengan Pencairan Deposito</h1>

            <div class="card">
                <div
                    class="card-header d-flex justify-content-between align-items-center"
                >
                    <div>
                        <h5 class="card-title mb-0">�� Trend Produk Funding</h5>
                        <small class="text-muted"
                            >Perkembangan Tabungan & Deposito per Bulan</small
                        >
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <!-- View Toggle Buttons -->
                        <div class="btn-group me-2" role="group">
                            <button
                                type="button"
                                class="btn btn-sm btn-primary"
                                id="btnCombinedTrendChart"
                                onclick="toggleCombinedTrendView('chart')"
                            >
                                <i class="ti ti-chart-line ti-xs me-1"></i>
                                Chart
                            </button>
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary"
                                id="btnCombinedTrendTable"
                                onclick="toggleCombinedTrendView('table')"
                            >
                                <i class="ti ti-table ti-xs me-1"></i> Table
                            </button>
                        </div>

                        <!-- Type Toggle Buttons -->
                        <div class="btn-group" role="group">
                            <button
                                type="button"
                                class="btn btn-sm btn-primary"
                                id="btnCombinedTrendNominal"
                                onclick="toggleCombinedTrendChart('nominal')"
                            >
                                <i class="ti ti-cash ti-xs me-1"></i> Nominal
                            </button>
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-primary"
                                id="btnCombinedTrendJumlah"
                                onclick="toggleCombinedTrendChart('jumlah')"
                            >
                                <i class="ti ti-users ti-xs me-1"></i> Jumlah
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card-header">
                    <div class="dropdown">
                        <button
                            class="btn btn-outline-success btn-sm dropdown-toggle"
                            type="button"
                            id="productFilterDropdown"
                            data-bs-toggle="dropdown"
                            aria-expanded="false"
                        >
                            <i class="ti ti-package ti-xs me-1"></i>
                            Filter Produk
                        </button>
                        <div
                            class="dropdown-menu"
                            aria-labelledby="productFilterDropdown"
                            style="
                                min-width: 300px;
                                max-height: 400px;
                                overflow-y: auto;
                            "
                        >
                            <!-- Total Options -->
                            <div class="px-3 py-2">
                                <h6 class="mb-2 fw-bold">Pilih Data</h6>
                                <div class="form-check mb-2">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        value="total_tabungan"
                                        id="filterTotalTabungan"
                                        checked
                                    />
                                    <label
                                        class="form-check-label"
                                        for="filterTotalTabungan"
                                    >
                                        Total Tabungan
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        value="total_deposito"
                                        id="filterTotalDeposito"
                                        checked
                                    />
                                    <label
                                        class="form-check-label"
                                        for="filterTotalDeposito"
                                    >
                                        Total Deposito
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        value="total_pencairan_deposito"
                                        id="filterTotalPencairanDeposito"
                                    />
                                    <label
                                        class="form-check-label"
                                        for="filterTotalPencairanDeposito"
                                    >
                                        Total Pencairan Deposito
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <div
                        id="combinedTrendChart"
                        style="min-height: 400px"
                    ></div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // Combined trend chart variable
            let combinedTrendChart = null;
            const combinedTrendEl = document.querySelector(
                "#combinedTrendChart"
            );
            let currentCombinedTrendType = "nominal";
            let currentCombinedTrendView = "chart";

            // Mock data for testing
            const mockData = {
                tabungan: {
                    data: [
                        {
                            kodeprd: "TAB001",
                            data: {
                                "2025-10": { nominal: 1000000000, jumlah: 100 },
                                "2025-11": { nominal: 1200000000, jumlah: 120 },
                            },
                        },
                    ],
                },
                deposito: {
                    data: [
                        {
                            kdprd: "DEP001",
                            data: {
                                "2025-10": { nominal: 500000000, jumlah: 50 },
                                "2025-11": { nominal: 600000000, jumlah: 60 },
                            },
                        },
                    ],
                },
                pencairan_deposito: {
                    data: [
                        {
                            kdprd: "PENCAIRAN",
                            data: {
                                "2025-08": { nominal: 0, jumlah: 0 },
                                "2025-09": { nominal: 2625053682, jumlah: 8 },
                                "2025-10": { nominal: 3287512094, jumlah: 9 },
                                "2025-11": { nominal: 11000000000, jumlah: 4 },
                            },
                        },
                    ],
                },
            };

            // Function to create combined trend view (chart or table)
            function createCombinedTrendView(type = "nominal", view = "chart") {
                if (combinedTrendChart) {
                    combinedTrendChart.destroy();
                }

                // Get selected filters
                const showTotalTabungan = document.getElementById(
                    "filterTotalTabungan"
                ).checked;
                const showTotalDeposito = document.getElementById(
                    "filterTotalDeposito"
                ).checked;
                const showTotalPencairanDeposito = document.getElementById(
                    "filterTotalPencairanDeposito"
                ).checked;

                // Show loading
                combinedTrendEl.innerHTML =
                    '<div class="text-center py-4"><div class="spinner-border" role="status"></div><br>Loading...</div>';

                // Simulate API calls with mock data
                setTimeout(() => {
                    const tabunganData =
                        showTotalTabungan || mockData.tabungan.data.length > 0
                            ? mockData.tabungan
                            : { data: [] };
                    const depositoData =
                        showTotalDeposito || mockData.deposito.data.length > 0
                            ? mockData.deposito
                            : { data: [] };
                    const pencairanData = showTotalPencairanDeposito
                        ? mockData.pencairan_deposito
                        : { data: [] };

                    const series = [];
                    const categories = [];
                    const tableRows = {};

                    // Collect all unique months
                    const allMonths = new Set();

                    if (tabunganData.data) {
                        tabunganData.data.forEach((product) => {
                            Object.keys(product.data).forEach((monthKey) => {
                                allMonths.add(monthKey);
                            });
                        });
                    }

                    if (depositoData.data) {
                        depositoData.data.forEach((product) => {
                            Object.keys(product.data).forEach((monthKey) => {
                                allMonths.add(monthKey);
                            });
                        });
                    }

                    if (pencairanData.data) {
                        pencairanData.data.forEach((product) => {
                            Object.keys(product.data).forEach((monthKey) => {
                                allMonths.add(monthKey);
                            });
                        });
                    }

                    // Sort months chronologically
                    const sortedMonths = Array.from(allMonths).sort();

                    // Create month labels and initialize table rows
                    sortedMonths.forEach((monthKey) => {
                        const [year, month] = monthKey.split("-");
                        const date = new Date(
                            parseInt(year),
                            parseInt(month) - 1,
                            1
                        );
                        const monthLabel = date.toLocaleDateString("id-ID", {
                            month: "short",
                            year: "numeric",
                        });
                        categories.push(monthLabel);
                        tableRows[monthKey] = { month: monthLabel };
                    });

                    // Process tabungan data
                    if (tabunganData.data && showTotalTabungan) {
                        const totalTabunganData = [];
                        sortedMonths.forEach((monthKey) => {
                            let total = 0;
                            tabunganData.data.forEach((product) => {
                                const monthData = product.data[monthKey];
                                if (monthData) {
                                    total +=
                                        type === "nominal"
                                            ? monthData.nominal
                                            : monthData.jumlah;
                                }
                            });
                            totalTabunganData.push(total);
                            tableRows[monthKey]["Total Tabungan"] = total;
                        });

                        series.push({
                            name:
                                type === "nominal"
                                    ? "Total Tabungan"
                                    : "Jumlah Rekening Tabungan",
                            data: totalTabunganData,
                            type: "line",
                        });
                    }

                    // Process deposito data
                    if (depositoData.data && showTotalDeposito) {
                        const totalDepositoData = [];
                        sortedMonths.forEach((monthKey) => {
                            let total = 0;
                            depositoData.data.forEach((product) => {
                                const monthData = product.data[monthKey];
                                if (monthData) {
                                    total +=
                                        type === "nominal"
                                            ? monthData.nominal
                                            : monthData.jumlah;
                                }
                            });
                            totalDepositoData.push(total);
                            tableRows[monthKey]["Total Deposito"] = total;
                        });

                        series.push({
                            name:
                                type === "nominal"
                                    ? "Total Deposito"
                                    : "Jumlah Rekening Deposito",
                            data: totalDepositoData,
                            type: "line",
                        });
                    }

                    // Process pencairan deposito data
                    if (pencairanData.data && showTotalPencairanDeposito) {
                        const totalPencairanData = [];
                        sortedMonths.forEach((monthKey) => {
                            let total = 0;
                            pencairanData.data.forEach((product) => {
                                const monthData = product.data[monthKey];
                                if (monthData) {
                                    total +=
                                        type === "nominal"
                                            ? monthData.nominal
                                            : monthData.jumlah;
                                }
                            });
                            totalPencairanData.push(total);
                            tableRows[monthKey]["Total Pencairan Deposito"] =
                                total;
                        });

                        series.push({
                            name:
                                type === "nominal"
                                    ? "Total Pencairan Deposito"
                                    : "Jumlah Pencairan Deposito",
                            data: totalPencairanData,
                            type: "line",
                        });
                    }

                    // If no data to show
                    if (series.length === 0) {
                        combinedTrendEl.innerHTML =
                            '<div class="text-center text-muted py-4"><i class="ti ti-info-circle ti-lg mb-2"></i><br>Pilih minimal satu filter data</div>';
                        return;
                    }

                    // Render based on view type
                    if (view === "table") {
                        renderCombinedTrendTable(tableRows, sortedMonths, type);
                    } else {
                        renderCombinedTrendChart(series, categories, type);
                    }
                }, 500);
            }

            // Function to render combined trend chart
            function renderCombinedTrendChart(series, categories, type) {
                const options = {
                    series: series,
                    chart: {
                        type: "line",
                        height: 400,
                        toolbar: { show: true },
                    },
                    colors: [
                        "#696cff",
                        "#03c3ec",
                        "#fdb528",
                        "#ff5722",
                        "#8592a3",
                        "#71dd37",
                        "#e91e63",
                        "#9c27b0",
                        "#607d8b",
                        "#795548",
                    ],
                    stroke: { curve: "smooth", width: 3 },
                    markers: { size: 4, hover: { size: 6 } },
                    dataLabels: {
                        enabled: true,
                        formatter: function (value) {
                            if (type === "nominal") {
                                if (value >= 1000000000) {
                                    return (
                                        "Rp " +
                                        (value / 1000000000).toFixed(2) +
                                        " M"
                                    );
                                } else if (value >= 1000000) {
                                    return (
                                        "Rp " +
                                        (value / 1000000).toFixed(2) +
                                        " Jt"
                                    );
                                } else if (value >= 100000) {
                                    return (
                                        "Rp " +
                                        (value / 1000).toFixed(0) +
                                        " Rb"
                                    );
                                } else if (value >= 1000) {
                                    return (
                                        "Rp " +
                                        (value / 1000).toFixed(1) +
                                        " Rb"
                                    );
                                } else {
                                    return "Rp " + value.toFixed(0);
                                }
                            }
                            return value + " rekening";
                        },
                        style: {
                            fontSize: "10px",
                            fontWeight: "bold",
                            colors: ["#333"],
                        },
                        background: {
                            enabled: true,
                            foreColor: "#fff",
                            padding: 4,
                            borderRadius: 2,
                            borderWidth: 1,
                            borderColor: "#fff",
                            opacity: 0.9,
                        },
                        offsetY: -10,
                    },
                    xaxis: { categories: categories, title: { text: "Bulan" } },
                    yaxis: {
                        title: {
                            text:
                                type === "nominal"
                                    ? "Nominal (Rp)"
                                    : "Jumlah Rekening",
                        },
                        labels: {
                            formatter: function (value) {
                                if (type === "nominal") {
                                    if (value >= 1000000000) {
                                        return (
                                            "Rp " +
                                            (value / 1000000000).toFixed(1) +
                                            "M"
                                        );
                                    } else if (value >= 1000000) {
                                        return (
                                            "Rp " +
                                            (value / 1000000).toFixed(1) +
                                            "Jt"
                                        );
                                    } else if (value >= 100000) {
                                        return (
                                            "Rp " +
                                            (value / 1000).toFixed(0) +
                                            "Rb"
                                        );
                                    } else {
                                        return (
                                            "Rp " +
                                            (value / 1000).toFixed(1) +
                                            "Rb"
                                        );
                                    }
                                }
                                return value;
                            },
                        },
                    },
                    tooltip: {
                        y: {
                            formatter: function (value) {
                                if (type === "nominal") {
                                    if (value >= 1000000000) {
                                        return (
                                            "Rp " +
                                            (value / 1000000000).toFixed(2) +
                                            " M"
                                        );
                                    } else if (value >= 1000000) {
                                        return (
                                            "Rp " +
                                            (value / 1000000).toFixed(2) +
                                            " Jt"
                                        );
                                    } else if (value >= 100000) {
                                        return (
                                            "Rp " +
                                            (value / 1000).toFixed(0) +
                                            " Rb"
                                        );
                                    } else {
                                        return (
                                            "Rp " +
                                            (value / 1000).toFixed(1) +
                                            " Rb"
                                        );
                                    }
                                }
                                return value + " rekening";
                            },
                        },
                    },
                    legend: { position: "top", horizontalAlign: "left" },
                };

                combinedTrendChart = new ApexCharts(combinedTrendEl, options);
                combinedTrendChart.render();
            }

            // Function to render combined trend table
            function renderCombinedTrendTable(tableRows, sortedMonths, type) {
                let html =
                    '<div class="table-responsive"><table class="table table-striped table-hover">';
                html += "<thead><tr><th>Bulan</th>";

                // Get all column names from first row
                const firstRow = tableRows[sortedMonths[0]];
                Object.keys(firstRow).forEach((key) => {
                    if (key !== "month") {
                        html += '<th class="text-end">' + key + "</th>";
                    }
                });
                html += "</tr></thead><tbody>";

                // Table body
                sortedMonths.forEach((monthKey) => {
                    const row = tableRows[monthKey];
                    html += "<tr>";
                    html += "<td><strong>" + row.month + "</strong></td>";

                    Object.keys(row).forEach((key) => {
                        if (key !== "month") {
                            const value = row[key];
                            let displayValue = "";
                            if (type === "nominal") {
                                if (value >= 1000000000) {
                                    displayValue =
                                        "Rp " +
                                        (value / 1000000000).toFixed(2) +
                                        " M";
                                } else if (value >= 1000000) {
                                    displayValue =
                                        "Rp " +
                                        (value / 1000000).toFixed(2) +
                                        " Jt";
                                } else if (value >= 100000) {
                                    displayValue =
                                        "Rp " +
                                        (value / 1000).toFixed(0) +
                                        " Rb";
                                } else if (value >= 1000) {
                                    displayValue =
                                        "Rp " +
                                        (value / 1000).toFixed(1) +
                                        " Rb";
                                } else {
                                    displayValue = "Rp " + value.toFixed(0);
                                }
                            } else {
                                displayValue = value.toLocaleString("id-ID");
                            }
                            html +=
                                '<td class="text-end">' +
                                displayValue +
                                "</td>";
                        }
                    });
                    html += "</tr>";
                });

                html += "</tbody></table></div>";
                combinedTrendEl.innerHTML = html;
            }

            // Toggle function for combined trend view (chart/table)
            window.toggleCombinedTrendView = function (view) {
                currentCombinedTrendView = view;
                document.getElementById("btnCombinedTrendChart").className =
                    view === "chart"
                        ? "btn btn-sm btn-primary"
                        : "btn btn-sm btn-outline-primary";
                document.getElementById("btnCombinedTrendTable").className =
                    view === "table"
                        ? "btn btn-sm btn-primary"
                        : "btn btn-sm btn-outline-primary";
                createCombinedTrendView(currentCombinedTrendType, view);
            };

            // Toggle function for combined trend chart type
            window.toggleCombinedTrendChart = function (type) {
                currentCombinedTrendType = type;
                document.getElementById("btnCombinedTrendNominal").className =
                    type === "nominal"
                        ? "btn btn-sm btn-primary"
                        : "btn btn-sm btn-outline-primary";
                document.getElementById("btnCombinedTrendJumlah").className =
                    type === "jumlah"
                        ? "btn btn-sm btn-primary"
                        : "btn btn-sm btn-outline-primary";
                createCombinedTrendView(type, currentCombinedTrendView);
            };

            // Event listeners
            document
                .getElementById("filterTotalTabungan")
                .addEventListener("change", () =>
                    createCombinedTrendView(
                        currentCombinedTrendType,
                        currentCombinedTrendView
                    )
                );
            document
                .getElementById("filterTotalDeposito")
                .addEventListener("change", () =>
                    createCombinedTrendView(
                        currentCombinedTrendType,
                        currentCombinedTrendView
                    )
                );
            document
                .getElementById("filterTotalPencairanDeposito")
                .addEventListener("change", () =>
                    createCombinedTrendView(
                        currentCombinedTrendType,
                        currentCombinedTrendView
                    )
                );

            // Initialize
            createCombinedTrendView("nominal", "chart");

            console.log("Final test implementation loaded successfully!");
        </script>
    </body>
</html>
