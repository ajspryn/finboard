<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Pencairan Deposito</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body>
    <h1>Test Filter Total Pencairan Deposito</h1>
    
    <div class="card">
        <div class="card-header">
            <h5>ðŸ“Š Trend Produk Funding</h5>
            <div class="d-flex gap-2">
                <div class="btn-group">
                    <button id="btnTestChart" class="btn btn-primary">Chart</button>
                    <button id="btnTestTable" class="btn btn-outline-primary">Table</button>
                </div>
                <div class="btn-group">
                    <button id="btnTestNominal" class="btn btn-primary">Nominal</button>
                    <button id="btnTestJumlah" class="btn btn-outline-primary">Jumlah</button>
                </div>
            </div>
            
            <div class="mt-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="filterTotalPencairanDeposito" checked>
                    <label class="form-check-label" for="filterTotalPencairanDeposito">
                        Total Pencairan Deposito
                    </label>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div id="testChart" style="min-height: 400px;"></div>
        </div>
    </div>

    <script>
        // Mock data - simulating fundingTrendData
        const fundingTrendData = {
            nominal: {
                tabungan: [1000000000, 1200000000, 1100000000, 1300000000, 1250000000, 1400000000],
                deposito: [500000000, 600000000, 550000000, 650000000, 620000000, 700000000],
                total: [1500000000, 1800000000, 1650000000, 1950000000, 1870000000, 2100000000],
                pencairan: [50000000, 60000000, 55000000, 65000000, 62000000, 70000000]
            },
            jumlah: {
                tabungan: [1000, 1200, 1100, 1300, 1250, 1400],
                deposito: [500, 600, 550, 650, 620, 700],
                total: [1500, 1800, 1650, 1950, 1870, 2100],
                pencairan: [50, 60, 55, 65, 62, 70]
            }
        };

        const fundingTrendLabels = ['Jan 2025', 'Feb 2025', 'Mar 2025', 'Apr 2025', 'Mei 2025', 'Jun 2025'];

        let combinedTrendChart = null;
        const combinedTrendEl = document.querySelector("#testChart");
        let currentCombinedTrendType = 'nominal';
        let currentCombinedTrendView = 'chart';

        function formatNominal(amount) {
            if (amount >= 1000000000) {
                return 'Rp ' + (amount / 1000000000).toFixed(2) + ' M';
            } else if (amount >= 1000000) {
                return 'Rp ' + (amount / 1000000).toFixed(2) + ' Jt';
            } else if (amount >= 1000) {
                return 'Rp ' + (amount / 1000).toFixed(1) + ' Rb';
            } else {
                return 'Rp ' + amount.toFixed(0);
            }
        }

        function createCombinedTrendView(type = 'nominal', view = 'chart') {
            if (combinedTrendChart) {
                combinedTrendChart.destroy();
            }

            // Get selected filters
            const showTotalPencairanDeposito = document.getElementById('filterTotalPencairanDeposito').checked;

            // Show loading
            combinedTrendEl.innerHTML = '<div class="text-center py-4"><div class="spinner-border" role="status"></div><br>Loading...</div>';

            // Simulate async operation
            setTimeout(() => {
                try {
                    const series = [];
                    const categories = [];
                    const tableRows = {};

                    // Always include months from funding trend data as fallback
                    fundingTrendLabels.forEach(label => {
                        // Convert label back to month key format (e.g., "Jan 2025" -> "2025-01")
                        const parts = label.split(' ');
                        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agt', 'Sep', 'Okt', 'Nov', 'Des'];
                        const monthIndex = monthNames.indexOf(parts[0]);
                        if (monthIndex !== -1) {
                            const year = parts[1];
                            const month = (monthIndex + 1).toString().padStart(2, '0');
                            const monthKey = `${year}-${month}`;
                            categories.push(label);
                            tableRows[monthKey] = { month: label };
                        }
                    });

                    const sortedMonths = Object.keys(tableRows);

                    // Process pencairan deposito data
                    if (showTotalPencairanDeposito) {
                        // Get pencairan data from funding trends
                        const pencairanData = fundingTrendData[type]['pencairan'];

                        // Validate that pencairan data exists
                        if (!pencairanData || !Array.isArray(pencairanData)) {
                            console.warn('Pencairan data not available');
                            combinedTrendEl.innerHTML = '<div class="text-center text-muted py-4"><i class="ti ti-alert-circle ti-lg mb-2"></i><br>Data pencairan tidak tersedia</div>';
                            return;
                        } else {
                            const pencairanSeriesData = [];

                            // Map pencairan data to months using fundingTrendLabels as reference
                            sortedMonths.forEach((monthKey) => {
                                // Find the corresponding index in fundingTrendLabels
                                const [year, month] = monthKey.split('-');
                                const date = new Date(parseInt(year), parseInt(month) - 1, 1);
                                const monthLabel = date.toLocaleDateString('id-ID', { month: 'short', year: 'numeric' });

                                // Find index in fundingTrendLabels
                                const labelIndex = fundingTrendLabels.indexOf(monthLabel);
                                let value = 0;

                                if (labelIndex !== -1 && pencairanData[labelIndex] !== undefined) {
                                    value = pencairanData[labelIndex];
                                    if (type === 'nominal') {
                                        // Data sudah dalam miliar, convert to actual value for chart
                                        value = value * 1000000000;
                                    }
                                }

                                pencairanSeriesData.push(value);
                                tableRows[monthKey]['Total Pencairan Deposito'] = value;
                            });

                            series.push({
                                name: type === 'nominal' ? 'Total Pencairan Deposito' : 'Jumlah Pencairan Deposito',
                                data: pencairanSeriesData,
                                type: 'line'
                            });
                        }
                    }

                    // If no data to show
                    if (series.length === 0) {
                        combinedTrendEl.innerHTML = '<div class="text-center text-muted py-4"><i class="ti ti-info-circle ti-lg mb-2"></i><br>Pilih minimal satu filter data</div>';
                        return;
                    }

                    // Render based on view type
                    if (view === 'table') {
                        renderCombinedTrendTable(tableRows, sortedMonths, type);
                    } else {
                        renderCombinedTrendChart(series, categories, type);
                    }
                } catch (error) {
                    console.error('Error in createCombinedTrendView:', error);
                    combinedTrendEl.innerHTML = '<div class="text-center text-muted py-4"><i class="ti ti-alert-circle ti-lg mb-2"></i><br>Gagal memuat data: ' + error.message + '</div>';
                }
            }, 500); // Simulate loading delay
        }

        function renderCombinedTrendChart(series, categories, type) {
            const options = {
                series: series,
                chart: {
                    type: 'line',
                    height: 400,
                    toolbar: { show: true }
                },
                colors: ['#696cff', '#03c3ec', '#fdb528'],
                stroke: { curve: 'smooth', width: 3 },
                markers: { size: 4 },
                xaxis: { categories: categories },
                yaxis: { 
                    title: { text: type === 'nominal' ? 'Nominal (Rp)' : 'Jumlah Rekening' },
                    labels: {
                        formatter: function(value) {
                            if (type === 'nominal') {
                                return formatNominal(value);
                            }
                            return value;
                        }
                    }
                },
                tooltip: {
                    y: {
                        formatter: function(value) {
                            if (type === 'nominal') {
                                return formatNominal(value);
                            }
                            return value + ' rekening';
                        }
                    }
                },
                legend: { position: 'top', horizontalAlign: 'left' }
            };

            combinedTrendChart = new ApexCharts(combinedTrendEl, options);
            combinedTrendChart.render();
        }

        function renderCombinedTrendTable(tableRows, sortedMonths, type) {
            let html = '<div class="table-responsive"><table class="table table-striped table-hover">';
            html += '<thead><tr><th>Bulan</th>';

            // Get all column names from first row
            const firstRow = tableRows[sortedMonths[0]];
            Object.keys(firstRow).forEach(key => {
                if (key !== 'month') {
                    html += '<th class="text-end">' + key + '</th>';
                }
            });
            html += '</tr></thead><tbody>';

            // Table body
            sortedMonths.forEach(monthKey => {
                const row = tableRows[monthKey];
                html += '<tr>';
                html += '<td><strong>' + row.month + '</strong></td>';

                Object.keys(row).forEach(key => {
                    if (key !== 'month') {
                        const value = row[key];
                        let displayValue = '';
                        if (type === 'nominal') {
                            displayValue = formatNominal(value);
                        } else {
                            displayValue = value.toLocaleString('id-ID');
                        }
                        html += '<td class="text-end">' + displayValue + '</td>';
                    }
                });
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            combinedTrendEl.innerHTML = html;
        }

        // Toggle functions
        window.toggleCombinedTrendView = function(view) {
            currentCombinedTrendView = view;
            document.getElementById('btnTestChart').className = view === 'chart' ? 'btn btn-primary' : 'btn btn-outline-primary';
            document.getElementById('btnTestTable').className = view === 'table' ? 'btn btn-primary' : 'btn btn-outline-primary';
            createCombinedTrendView(currentCombinedTrendType, view);
        };

        window.toggleCombinedTrendChart = function(type) {
            currentCombinedTrendType = type;
            document.getElementById('btnTestNominal').className = type === 'nominal' ? 'btn btn-primary' : 'btn btn-outline-primary';
            document.getElementById('btnTestJumlah').className = view === 'jumlah' ? 'btn btn-primary' : 'btn btn-outline-primary';
            createCombinedTrendView(type, currentCombinedTrendView);
        };

        // Event listeners
        document.getElementById('btnTestChart').addEventListener('click', () => toggleCombinedTrendView('chart'));
        document.getElementById('btnTestTable').addEventListener('click', () => toggleCombinedTrendView('table'));
        document.getElementById('btnTestNominal').addEventListener('click', () => toggleCombinedTrendChart('nominal'));
        document.getElementById('btnTestJumlah').addEventListener('click', () => toggleCombinedTrendChart('jumlah'));
        document.getElementById('filterTotalPencairanDeposito').addEventListener('change', () => createCombinedTrendView(currentCombinedTrendType, currentCombinedTrendView));

        // Initialize
        createCombinedTrendView('nominal', 'chart');
        
        console.log('Test pencairan deposito loaded successfully!');
    </script>
</body>
</html>
