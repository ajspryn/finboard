<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Clickable Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1>Test Clickable Chart & Table</h1>
        
        <div class="card">
            <div class="card-header">
                <h5>ðŸ“Š Trend Produk Funding</h5>
                <div class="d-flex gap-2">
                    <div class="btn-group">
                        <button id="btnTestChart" class="btn btn-primary">Chart</button>
                        <button id="btnTestTable" class="btn btn-outline-primary">Table</button>
                    </div>
                    <div class="btn-group">
                        <button id="btnTestNominal" class="btn btn-primary">Nominal</button>
                        <button id="btnTestJumlah" class="btn btn-outline-primary">Jumlah</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="testChart" style="min-height: 400px;"></div>
            </div>
        </div>
    </div>

    <!-- Customer Details Modal -->
    <div class="modal fade customer-modal" id="customerDetailsModal" tabindex="-1" aria-labelledby="customerDetailsModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerDetailsModalTitle">Detail Nasabah</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="customerDetailsModalBody">
                    <!-- Content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mock data
        const fundingTrendData = {
            nominal: {
                tabungan: [1000000000, 1200000000, 1100000000, 1300000000, 1250000000, 1400000000],
                deposito: [500000000, 600000000, 550000000, 650000000, 620000000, 700000000],
                pencairan: [50000000, 60000000, 55000000, 65000000, 62000000, 70000000]
            },
            jumlah: {
                tabungan: [1000, 1200, 1100, 1300, 1250, 1400],
                deposito: [500, 600, 550, 650, 620, 700],
                pencairan: [50, 60, 55, 65, 62, 70]
            }
        };

        const fundingTrendLabels = ['Jan 2025', 'Feb 2025', 'Mar 2025', 'Apr 2025', 'Mei 2025', 'Jun 2025'];

        let combinedTrendChart = null;
        const combinedTrendEl = document.querySelector("#testChart");
        let currentCombinedTrendType = 'nominal';
        let currentCombinedTrendView = 'chart';

        // Helper function for formatting nominal
        function formatNominal(amount) {
            if (amount >= 1000000000) {
                return 'Rp ' + (amount / 1000000000).toFixed(2) + ' M';
            } else if (amount >= 1000000) {
                return 'Rp ' + (amount / 1000000).toFixed(2) + ' Jt';
            } else if (amount >= 1000) {
                return 'Rp ' + (amount / 1000).toFixed(1) + ' Rb';
            } else {
                return 'Rp ' + amount.toFixed(0);
            }
        }

        function createCombinedTrendView(type = 'nominal', view = 'chart') {
            if (combinedTrendChart) {
                combinedTrendChart.destroy();
            }

            const series = [];
            const categories = fundingTrendLabels;
            const tableRows = {};

            // Initialize table data structure
            fundingTrendLabels.forEach((month, index) => {
                tableRows[month] = { month: month };
            });

            // Process tabungan data
            const totalTabunganData = fundingTrendData[type]['tabungan'];
            series.push({
                name: type === 'nominal' ? 'Total Tabungan' : 'Jumlah Rekening Tabungan',
                data: totalTabunganData,
                type: 'line'
            });
            fundingTrendLabels.forEach((month, index) => {
                tableRows[month]['Total Tabungan'] = totalTabunganData[index];
            });

            // Process deposito data
            const totalDepositoData = fundingTrendData[type]['deposito'];
            series.push({
                name: type === 'nominal' ? 'Total Deposito' : 'Jumlah Rekening Deposito',
                data: totalDepositoData,
                type: 'line'
            });
            fundingTrendLabels.forEach((month, index) => {
                tableRows[month]['Total Deposito'] = totalDepositoData[index];
            });

            // Process pencairan deposito data
            const pencairanData = fundingTrendData[type]['pencairan'];
            series.push({
                name: type === 'nominal' ? 'Total Pencairan Deposito' : 'Jumlah Pencairan Deposito',
                data: pencairanData,
                type: 'line'
            });
            fundingTrendLabels.forEach((month, index) => {
                tableRows[month]['Total Pencairan Deposito'] = pencairanData[index];
            });

            // Render based on view type
            if (view === 'table') {
                renderCombinedTrendTable(tableRows, fundingTrendLabels, type);
            } else {
                renderCombinedTrendChart(series, categories, type);
            }
        }

        function renderCombinedTrendChart(series, categories, type) {
            const options = {
                series: series,
                chart: {
                    type: 'line',
                    height: 400,
                    toolbar: { show: true },
                    events: {
                        markerClick: function(event, chartContext, { seriesIndex, dataPointIndex, config }) {
                            const seriesName = config.series[seriesIndex].name;
                            const category = config.xaxis.categories[dataPointIndex];
                            handleChartDataClick(seriesName, category, type);
                        },
                        dataPointSelection: function(event, chartContext, { seriesIndex, dataPointIndex, config }) {
                            const seriesName = config.series[seriesIndex].name;
                            const category = config.xaxis.categories[dataPointIndex];
                            handleChartDataClick(seriesName, category, type);
                        }
                    }
                },
                colors: ['#696cff', '#03c3ec', '#fdb528'],
                stroke: { curve: 'smooth', width: 3 },
                markers: { size: 4, hover: { size: 6 } },
                xaxis: { categories: categories },
                yaxis: { 
                    title: { text: type === 'nominal' ? 'Nominal (Rp)' : 'Jumlah Rekening' },
                    labels: {
                        formatter: function(value) {
                            if (type === 'nominal') {
                                return formatNominal(value);
                            }
                            return value;
                        }
                    }
                },
                tooltip: {
                    y: {
                        formatter: function(value) {
                            if (type === 'nominal') {
                                return formatNominal(value);
                            }
                            return value + ' rekening';
                        }
                    }
                },
                legend: { position: 'top', horizontalAlign: 'left' }
            };

            combinedTrendChart = new ApexCharts(combinedTrendEl, options);
            combinedTrendChart.render();
        }

        function renderCombinedTrendTable(tableRows, sortedMonths, type) {
            let html = '<div class="table-responsive"><table class="table table-striped table-hover">';
            html += '<thead><tr><th>Bulan</th>';

            const firstRow = tableRows[sortedMonths[0]];
            Object.keys(firstRow).forEach(key => {
                if (key !== 'month') {
                    html += '<th class="text-end">' + key + '</th>';
                }
            });
            html += '</tr></thead><tbody>';

            sortedMonths.forEach(monthKey => {
                const row = tableRows[monthKey];
                html += '<tr>';
                html += '<td><strong>' + row.month + '</strong></td>';

                Object.keys(row).forEach(key => {
                    if (key !== 'month') {
                        const value = row[key];
                        let displayValue = '';
                        if (type === 'nominal') {
                            displayValue = formatNominal(value);
                        } else {
                            displayValue = value.toLocaleString('id-ID');
                        }
                        html += '<td class="text-end clickable-cell" onclick="handleTableRowClick(\'' + monthKey + '\', \'' + key + '\', \'' + type + '\')" style="cursor: pointer;" title="Klik untuk lihat detail nasabah ' + key + '">' + displayValue + '</td>';
                    }
                });
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            combinedTrendEl.innerHTML = html;
        }

        // Function to handle chart data point clicks
        function handleChartDataClick(seriesName, category, type) {
            console.log('Chart data clicked:', { seriesName, category, type });

            let jenis = '';
            if (seriesName.includes('Tabungan')) {
                jenis = 'tabungan';
            } else if (seriesName.includes('Deposito') && seriesName.includes('Pencairan')) {
                jenis = 'pencairan_deposito';
            } else if (seriesName.includes('Deposito')) {
                jenis = 'deposito';
            }

            showCustomerDetails(jenis, type);
        }

        // Function to handle table row clicks
        function handleTableRowClick(monthKey, columnName, type) {
            console.log('Table row clicked:', { monthKey, columnName, type });

            let jenis = '';
            if (columnName.includes('Tabungan')) {
                jenis = 'tabungan';
            } else if (columnName.includes('Deposito') && columnName.includes('Pencairan')) {
                jenis = 'pencairan_deposito';
            } else if (columnName.includes('Deposito')) {
                jenis = 'deposito';
            }

            showCustomerDetails(jenis, type);
        }

        // Customer Details Modal Functions
        function showCustomerDetails(jenis, type) {
            const modal = new bootstrap.Modal(document.getElementById('customerDetailsModal'));
            const modalTitle = document.getElementById('customerDetailsModalTitle');
            const modalBody = document.getElementById('customerDetailsModalBody');

            let title = '';
            switch(jenis) {
                case 'tabungan':
                    title = 'Detail Nasabah Tabungan';
                    break;
                case 'deposito':
                    title = 'Detail Nasabah Deposito';
                    break;
                case 'pencairan_deposito':
                    title = 'Detail Pencairan Deposito';
                    break;
                default:
                    title = 'Detail Nasabah';
            }
            modalTitle.textContent = title;

            // Mock customer data
            const mockCustomers = [];
            for (let i = 1; i <= 10; i++) {
                mockCustomers.push({
                    nama: `Nasabah ${i}`,
                    account: `ACC${String(i).padStart(3, '0')}`,
                    amount: Math.floor(Math.random() * 100000000) + 10000000,
                    type: jenis === 'tabungan' ? 'Tabungan' : 'Deposito',
                    period: '2025-11'
                });
            }

            let html = '<div class="table-responsive">';
            html += '<table class="table table-striped table-hover">';
            html += '<thead><tr>';
            html += '<th>No</th>';
            html += '<th>Nama Nasabah</th>';
            html += '<th>No Rekening</th>';
            html += '<th>Nominal</th>';
            html += '<th>Periode</th>';
            html += '</tr></thead><tbody>';

            mockCustomers.forEach((customer, index) => {
                html += '<tr class="customer-detail-row">';
                html += `<td>${index + 1}</td>`;
                html += `<td>${customer.nama}</td>`;
                html += `<td>${customer.account}</td>`;
                html += `<td>${formatNominal(customer.amount)}</td>`;
                html += `<td>${customer.period}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            html += `<div class="mt-3 text-muted">Menampilkan ${mockCustomers.length} nasabah (data mockup)</div>`;
            html += '</div>';
            modalBody.innerHTML = html;

            modal.show();
        }

        // Toggle functions
        window.toggleCombinedTrendView = function(view) {
            currentCombinedTrendView = view;
            document.getElementById('btnTestChart').className = view === 'chart' ? 'btn btn-primary' : 'btn btn-outline-primary';
            document.getElementById('btnTestTable').className = view === 'table' ? 'btn btn-primary' : 'btn btn-outline-primary';
            createCombinedTrendView(currentCombinedTrendType, view);
        };

        window.toggleCombinedTrendChart = function(type) {
            currentCombinedTrendType = type;
            document.getElementById('btnTestNominal').className = type === 'nominal' ? 'btn btn-primary' : 'btn btn-outline-primary';
            document.getElementById('btnTestJumlah').className = type === 'jumlah' ? 'btn btn-primary' : 'btn btn-outline-primary';
            createCombinedTrendView(type, currentCombinedTrendView);
        };

        // Event listeners
        document.getElementById('btnTestChart').addEventListener('click', () => toggleCombinedTrendView('chart'));
        document.getElementById('btnTestTable').addEventListener('click', () => toggleCombinedTrendView('table'));
        document.getElementById('btnTestNominal').addEventListener('click', () => toggleCombinedTrendChart('nominal'));
        document.getElementById('btnTestJumlah').addEventListener('click', () => toggleCombinedTrendChart('jumlah'));

        // Initialize
        createCombinedTrendView('nominal', 'chart');
        
        console.log('Test clickable chart loaded successfully!');
    </script>

    <style>
        .clickable-cell {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .clickable-cell:hover {
            background-color: rgba(0,123,255,0.1) !important;
            transform: scale(1.05);
        }
        #testChart .apexcharts-marker {
            cursor: pointer !important;
            pointer-events: all !important;
        }
        #testChart .apexcharts-series path {
            cursor: pointer !important;
        }
    </style>
</body>
</html>
